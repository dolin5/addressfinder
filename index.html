<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the widgets-search-multiplesource sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/widgets-search-multiplesource/index.html
  -->
    <title>Search widget with multiple sources - 4.12</title>

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.11/"></script>

    <script>
        require([
            "esri/WebMap",

            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/widgets/Search"
        ], function(WebMap, MapView, FeatureLayer, Search) {
            var structures;
            var structuresSearchLayer;
            var recentAddresses;
            var retiredAddresses;
            var addressMasterTable;
            var searchWidget;


            var map = new WebMap({
                portalItem: {
                    id: "abbe4d6454854f4bab38d82b54a359e9"
                }
            });

            var view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-111.15, 45.7], // lon, lat
                scale: 200000
            });
            map.load().then(function() {
                console.log(map);
                var sources = [];
                map.layers.forEach(function(layer, index) {
                    if (layer.title == "retired_address") {
                        retiredAddresses = layer;
                    } else if (layer.title == "recent_address") {
                        recentAddresses = layer;
                    } else if (layer.title == "structures") {                   
                        getStructuresSearchLayer(layer);                                                      
                    }
                });
                addressMasterTable = new FeatureLayer({
                    url: map.tables[0].url
                });

                sources.push(                //  {
                //         layer: structures,
                //         searchFields: ["ADDRESS"],
                //         suggestionTemplate: "{ADDRESS} {DIRPRE} {ROADNAME} {ROADTYPE} {DIRSUF}",
                //         exactMatch: true,
                //         maxSuggestions: 10000,
                //         outFields: ["ADDRESS", "DIRPRE", "ROADNAME", "ROADTYPE", "DIRSUF"],
                //         name: "structures",
                //         placeholder: "311 w main st",
                //         getSuggestions:getStructureSuggestions,
                //     },
                    // {
                    //     layer: recentAddresses,
                    //     searchFields: ["ADDRESS"],
                    //     suggestionTemplate: "{ADDRESS} {DIRPRE} {ROADNAME} {ROADTYPE} {DIRSUF}",
                    //     exactMatch: true,
                    //     maxSuggestions: 10,
                    //     outFields: ["ADDRESS", "DIRPRE", "ROADNAME", "ROADTYPE", "DIRSUF"],
                    //     name: "recent addresses",
                    //     placeholder: "311 w main st"
                    // }
                    // {
                    //   layer: structures,
                    //   searchFields: ["Name", "Party"],
                    //   suggestionTemplate: "{Name}, Party: {Party}",
                    //   exactMatch: false,
                    //   outFields: ["*"],
                    //   placeholder: "example: Casey",
                    //   name: "Senators",
                    //   zoomScale: 500000,
                    //   resultSymbol: {
                    //     type: "picture-marker", // autocasts as new PictureMarkerSymbol()
                    //     url:
                    //       "https://developers.arcgis.com/javascript/latest/sample-code/widgets-search-multiplesource/live/images/senate.png",
                    //     height: 36
                    //   }
                    // }
                );

                searchWidget.set("sources", sources);

            });

            // var featureLayerDistricts = new FeatureLayer({
            //   url:
            //     "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/CongressionalDistricts/FeatureServer/0",
            //   popupTemplate: {
            //     // autocasts as new PopupTemplate()
            //     title: "Congressional District {DISTRICTID} </br>{NAME},{PARTY}",
            //     overwriteActions: true
            //   }
            // });

            // var featureLayerSenators = new FeatureLayer({
            //   url:
            //     "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/US_Senators/FeatureServer/0",
            //   popupTemplate: {
            //     // autocasts as new PopupTemplate()
            //     title:
            //       "<a href={Web_Page} target='_blank'> {Name}</a>, ({Party}-{State}) ",
            //     overwriteActions: true
            //   }
            // });


            searchWidget = new Search({
                view: view,
                allPlaceholder: "wait",
                includeDefaultSources: false
            });
            searchWidget.on("search-start",function(event){
              console.log(event);
            });
            searchWidget.viewModel.on("search-start",function(event){
              console.log(event);
            });
            // Add the search widget to the top left corner of the view
            view.ui.add(searchWidget, {
                position: "top-right"
            }); 

            searchWidget.on("suggest-complete", function(event){
              // The results are stored in the event Object[]
              console.log("Results of suggest: ", event);
            });

            function getStructuresSearchLayer(structuresLayer){
              var structuresSearchQuery = structuresLayer.createQuery();
              structuresSearchQuery.where = "1=1";
              structuresSearchQuery.outSpatialReference = view.spatialReference;
              structuresSearchQuery.outFields = ["OBJECTID","ADDRESS", "DIRPRE", "ROADNAME", "ROADTYPE", "DIRSUF"];
              var structuresRequest = structuresLayer.queryFeatures(structuresSearchQuery).then(function(results){
                console.log(results);
                var fullAddressFieldObject = Object.assign(results.fields[3]);
                fullAddressFieldObject.name = "FULLADDRESS";
                fullAddressFieldObject.alias = "FULLADDRESS";
                results.features.forEach(function(feature,index){
                  feature.attributes["FULLADDRESS"] = fullAddressMaker(feature);

                });
                structuresSearchLayer = new FeatureLayer({
                  source : results.features,
                  fields: results.fields.concat(fullAddressFieldObject),
                  outFields: ["*"],
                  objectIdField: "OBJECTID",
                  title: "structure-search-layer",
                  visible:false
                });   
                structuresSearchLayer.when(updateSources);   
                map.layers.add(structuresSearchLayer);        
              });
            }

            function buildStructureSearchLayer(results){
              console.log(results);
              results.features.forEach(function(feature,index){
                feature.attributes["FULLADDRESS"] = fullAddressMaker(feature);

              });
              structureSearchLayer = new FeatureLayer({
                source: results.features,
                outFields: ["OBJECTID","ADDRESS", "DIRPRE", "ROADNAME", "ROADTYPE", "DIRSUF","FULLADDRESS"],
                fields: ["OBJECTID","ADDRESS", "DIRPRE", "ROADNAME", "ROADTYPE", "DIRSUF","FULLADDRESS"]
              });
              structureSearchLayer.on("load",function(layer){
                return layer;
              })              
            }
            function fullAddressMaker(feature){
              var attributes = feature.attributes
              Object.keys(attributes).forEach(function(key) {
                if(attributes[key] === null) {
                  attributes[key] = '';
                }
                if (typeof attributes[key].replace === 'function'){
                  attributes[key] = attributes[key].replace(/  +/g, ' ').trim();
                }                
              })
              var fullAddress = (attributes.ADDRESS + " " + attributes.DIRPRE + " " + attributes.ROADNAME + " " + attributes.ROADTYPE + " " + attributes.DIRSUF).replace(/  +/g, ' ').trim();
              return fullAddress;
            }

            function updateSources(layer){              
              searchWidget.sources.push({
                layer: layer,
                searchFields: ["FULLADDRESS"],
                suggestionTemplate: "{FULLADDRESS}",
                name: "structures",
                maxSuggestions: 6,
                maxResults:6,
                placeholder: "311 w main st",
                outFields: ["*"],
                zoomScale:1000,
                exactMatch: false,
                suggestionsEnabled:true,
                getSuggestions: function(params) {
                  var someFunction = function(items,params){
                    return new Promise(function (resolve, reject) {
                      var results = items.filter(function(feature){return feature.attributes.FULLADDRESS.startsWith(params.suggestTerm.toUpperCase())}).slice(0,7).map(function(feature){
                        return {
                          key:"FULLADDRESS",
                          text:feature.attributes.FULLADDRESS,
                          index:params.sourceIndex
                        }
                      });
                      resolve(results);
                    });
                  }
                  return someFunction(this.layer.source.items,params);            
                },
                getResults: function(params) {
                  // If the Search widget passes the current location,
                  // you can use this in your own custom source
                  var operation = params.location ? "reverse/" : "search/";
                  var query = {};
                  // You can perform a different query if a location
                  // is provided
                  if (params.location) {
                    query.lat = params.location.latitude;
                    query.lon = params.location.longitude;
                  } else {
                    query.q = params.suggestResult.text.replace(/ /g, "+");
                    query.limit = 6;
                  }
                  return esriRequest(url + operation, {
                    query: query,
                    responseType: "json"
                  }).then(function(results) {
                    // Parse the results of your custom search
                    var searchResults = results.data.features.map(function(feature) {
                      // Create a Graphic the Search widget can display
                      var graphic = new Graphic({
                        geometry: new Point({
                          x: feature.geometry.coordinates[0],
                          y: feature.geometry.coordinates[1]
                        }),
                        attributes: feature.properties
                      });
                      // Optionally, you can provide an extent for
                      // a point result, so the view can zoom to it
                      var buffer = geometryEngine.geodesicBuffer(
                        graphic.geometry,
                        100,
                        "meters"
                      );
                      // Return a Search Result
                      var searchResult = {
                        extent: buffer.extent,
                        feature: graphic,
                        name: feature.properties.label
                      };
                      return searchResult;
                    });

                    // Return an array of Search Results
                    return searchResults;
                  });
                }

              });                          
            }

            function getStructureSuggestions(params){                    
            }
        });
    </script>
</head>

<body>
    <div id="viewDiv"></div>
</body>

</html>